{
    "rules": {
        "user_directory": {
            // Only admins can read the full directory? Or maybe just themselves.
            // For now, let's say authenticated users can read their own entry.
            "$uid": {
                ".read": "auth.uid === $uid",
                ".write": false // Only updated by super-admin scripts or initial logic
            }
        },
        "laboratories": {
            "$lab_id": {
                // Enforce that the user belongs to this lab
                ".read": "root.child('user_directory').child(auth.uid).child('lab_id').val() === $lab_id",
                // CONFIG: Only Admins of this lab can write
                "config": {
                    ".write": "root.child('user_directory').child(auth.uid).child('role').val() === 'admin' && root.child('user_directory').child(auth.uid).child('lab_id').val() === $lab_id"
                },
                // REPORTS: Staff and Admins can write
                "reports": {
                    ".write": "root.child('user_directory').child(auth.uid).child('lab_id').val() === $lab_id"
                },
                // Default write rule for other nodes in the lab (orders, patients, etc.) if not specified above
                // Assuming strict isolation: must be in the lab to write
                ".write": "root.child('user_directory').child(auth.uid).child('lab_id').val() === $lab_id"
            }
        }
    }
}